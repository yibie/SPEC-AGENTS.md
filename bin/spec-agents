#!/bin/bash
set -e

# Spec-AGENTS CLI
# è‡ªåŠ¨å®šä½ä»“åº“æ ¹ç›®å½•ï¼ˆå³è„šæœ¬æ‰€åœ¨ç›®å½•çš„ä¸Šä¸€çº§ï¼‰
# å…¼å®¹ macOS/Linux çš„ readlink é—®é¢˜

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
REPO_ROOT="$( cd -P "$( dirname "$SOURCE" )/.." && pwd )"

# CLI Argument Parsing
COMMAND="$1"
TARGET_DIR="${2:-.}" # Default to current directory
LANG="${3:-cn}"      # Default to Chinese

show_help() {
  echo "ğŸ¤– Spec-AGENTS CLI v2.2.0"
  echo ""
  echo "Usage:"
  echo "  spec-agents init [lang]         Initialize in current directory"
  echo "  spec-agents install <path> [lang] Install to specific directory"
  echo ""
  echo "Arguments:"
  echo "  lang: cn (default) | en"
  echo ""
  echo "Examples:"
  echo "  spec-agents init"
  echo "  spec-agents init en"
  echo "  spec-agents install ../my-new-project cn"
}

if [ -z "$COMMAND" ] || [ "$COMMAND" == "help" ] || [ "$COMMAND" == "--help" ] || [ "$COMMAND" == "-h" ]; then
  show_help
  exit 0
fi

# Normalize Target Directory
if [ "$COMMAND" == "init" ]; then
    TARGET_DIR="."
    LANG="${2:-cn}"
elif [ "$COMMAND" == "install" ]; then
    if [ -z "$2" ]; then
        echo "âŒ Error: Please specify target path for 'install' command."
        exit 1
    fi
    TARGET_DIR="$2"
    LANG="${3:-cn}"
else
    echo "âŒ Unknown command: $COMMAND"
    show_help
    exit 1
fi

# Execution Logic
echo "ğŸš€ Initializing Spec-AGENTS v2..."
echo "   ğŸ“‚ Source: $REPO_ROOT"
echo "   ğŸ¯ Target: $TARGET_DIR"

if [ ! -d "$TARGET_DIR" ]; then
  echo "   âš ï¸  Target directory does not exist. Creating..."
  mkdir -p "$TARGET_DIR"
fi

# 1. Install Modules
echo "   ğŸ“¦ Copying intelligent modules..."
mkdir -p "$TARGET_DIR/.phrase/modules"
mkdir -p "$TARGET_DIR/.phrase/docs"
mkdir -p "$TARGET_DIR/.phrase/phases"
cp -R "$REPO_ROOT/.phrase/modules/"* "$TARGET_DIR/.phrase/modules/"

# 2. Install Core Protocol
echo "   ğŸ“„ Copying AGENTS.md..."
if [ "$LANG" == "en" ]; then
  cp "$REPO_ROOT/AGENTS_en.md" "$TARGET_DIR/AGENTS.md"
  echo "   ğŸŒ Language: English"
else
  cp "$REPO_ROOT/AGENTS.md" "$TARGET_DIR/AGENTS.md"
  echo "   ğŸŒ Language: Chinese"
fi

echo ""
echo "âœ¨ Done! Spec-AGENTS is ready."
echo "   To start, simply tell your AI Agent: 'Read AGENTS.md'"
